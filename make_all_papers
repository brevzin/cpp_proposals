#!/usr/bin/env python3
import glob
import os
import re
import collections
import sys
import frontmatter
from typing import Any
from bs4 import BeautifulSoup
import jinja2
import attrs

def get_title(filename):
    with open(filename) as f:
        html = BeautifulSoup(f.read(), 'html.parser')
        text = ' '.join(map(str,html.h1.children))
        return text.replace('<p>', '').replace('</p>','')

def get_markdown_from(path, num):
    mds = glob.glob(f"{path}/*.md")
    if len(mds) == 1:
        return mds[0]

    makefile = f'{path}/Makefile'
    if not os.path.exists(makefile):
        return None

    with open(makefile) as f:
        for line in f:
            try:
                dst, src = line.split(':')
                dst = dst.strip()
                src = src.strip()

                if dst.startswith(f'p{num}r'):
                    return f"{path}/{src}"
            except ValueError:
                pass

    return None

def get_tag_from_md(path, num):
    md = get_markdown_from(path, num)
    if md is None:
        return

    paper = frontmatter.load(open(md))
    return paper.get('tag', None)

def get_frontmatter_from(path, num):
    md = get_markdown_from(path, num)
    if md is None:
        return

    return frontmatter.load(open(md))

iso = re.compile(r'([pd])(\d{4})r(\d+).html')
papers = collections.defaultdict(list)
others = []

@attrs.define(order=True)
class Paper:
    rev : int
    pd : str
    yaml : Any | None = attrs.field(eq=False, order=False)
    filename : str


for filename in glob.glob(f'*/*.html'):
    path, base = os.path.split(filename)
    if path in ('sd6', 'md'):
        continue

    m = iso.match(base)
    if m:
        pd, num, rev = m.groups()
        num = int(num)
        rev = int(rev)
        papers[num].append(Paper(
            rev=rev,
            pd=pd,
            yaml=get_frontmatter_from(path, num),
            filename=filename))
    else:
        others.append((base, filename))

titles = {847: "Deducing <code>this</code>"}
initial_status = {
    312: "rejected",
    573: "rejected",
    644: "rejected",
    704: "accepted",
    780: "accepted",
    892: "accepted",
    893: "rejected",
    1170: "abandoned",
    1185: "accepted",
    1186: "accepted",
    1187: "accepted",
    1188: "accepted",
    1189: "accepted",
    1500: "abandoned",
    1614: "accepted",
    1630: "accepted",
}

template = jinja2.Template(open("all_papers.tpl").read())
numbered_papers = []

numbered_papers = {
    "accepted": [],
    "rejected": [],
    "abandoned": [],
    "progress": [],
}

badges = {
    "ranges": "-ranges-brightgreen",
    "constexpr": "-constexpr-blueviolet",
    "spaceship": "-%3C%3D%3E-yellow",
    "reflection": "-reflection-orange",
}

for num in sorted(papers):
    vals = sorted(papers[num])
    title = titles.get(num)
    if title is None:
        title = get_title(vals[-1].filename)

    current = {"number": f"P{num:04}", "title": title}
    current["revisions"] = [
        {
            "href": val.filename,
            "name": f"{val.pd}{num:04}r{val.rev}"
        }
        for val in vals
    ]

    status = initial_status.get(num, "progress")
    if vals[-1].yaml is not None:
        tag = vals[-1].yaml.get("tag", None)
        if tag is not None:
            current["badge"] = badges[tag]
        status = vals[-1].yaml.get("status", status)

    numbered_papers[status].append(current)

print(
    template.render(numbered_papers),
    file=open("all_papers.html", "w")
)

# out = open('all_papers.md', 'w')
# print('# Papers with Numbers', file=out)
# titles = {847: "Deducing `this`"}
# for num in sorted(papers):
#     vals = sorted(papers[num])
#     title = titles.get(num)
#     if title is None:
#         title = get_title(vals[-1][-1])
#     all_revs = ' '.join(f'[{pd}{num:04d}r{rev}]({filename})' for (rev, pd, _, filename) in vals)

#     tag = vals[-1][2]
#     if tag is None:
#         tag_str = ''
#     else:
#         tag_str = f'![][~{tag}] '
#     print(f'- {tag_str}P{num:04} {title}: {all_revs}', file=out)

# print(file=out)
# print('[~ranges]: https://img.shields.io/badge/-ranges-brightgreen', file=out)
# print('[~constexpr]: https://img.shields.io/badge/-constexpr-blueviolet', file=out)
# print('[~spaceship]: https://img.shields.io/badge/-%3C%3D%3E-yellow', file=out)
# print(file=out)
# print('# Other Papers', file=out)
# for (base, filename) in sorted(others):
#     print(f'- {get_title(filename)}: [{base}]({filename})', file=out)
